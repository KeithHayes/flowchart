st=>start: Start process_file()

op1=>operation: Load and clean text from INPUT_FILE
→ normalize line breaks and whitespace

op2=>operation: Split text into chunks with overlap
→ _chunk_text()

op3=>operation: For each chunk:
  Combine with previous_tail if exists

op4=>operation: Call LLMFormatter.punctuate_text(combined)

cond1=>condition: Was response valid?

cond1(no)->op5=>operation: Log warning
→ Use original text

cond1(yes)->op6=>operation: Extract new_content
→ aligner.extract_new_content()

cond2=>condition: Is new_content non-empty?

cond2(yes)->op7=>operation: Add new_content to formatted_parts
→ Update previous_tail
→ aligner.get_tail_for_context()

cond2(no)->op8=>operation: Skip adding

op9=>operation: Repeat for all chunks

op10=>operation: Join formatted_parts
→ Reformat with spacing and punctuation fixes

op11=>operation: Save to OUTPUT_FILE

e=>end: Done

st->op1->op2->op3->op4->cond1
cond1(no)->op5->op9
cond1(yes)->op6->cond2
cond2(yes)->op7->op9
cond2(no)->op8->op9
op9->op10->op11->e
